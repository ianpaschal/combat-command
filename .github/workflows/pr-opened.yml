name: PR Opened Automation

on:
  pull_request:
    types: [opened]

jobs:
  link-issue-and-update-status:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Extract issue number and update PR body
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            const match = branch.match(/^(\d+)/);
            if (!match) {
              console.log(`No issue number found in branch: ${branch}`);
              return;
            }
            const issueNumber = match[1];
            const body = context.payload.pull_request.body || '';
            const updatedBody = body.replace('#???', `#${issueNumber}`);
            if (body === updatedBody) {
              console.log('No #??? placeholder found in PR body');
              return;
            }
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: updatedBody,
            });
            console.log(`Replaced #??? with #${issueNumber}`);

      - name: Update project status to In Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_AUTOMATION_TOKEN }}
          script: |
            const branch = context.payload.pull_request.head.ref;
            const match = branch.match(/^(\d+)/);
            if (!match) {
              console.log(`No issue number found in branch: ${branch}`);
              return;
            }
            const issueNumber = parseInt(match[1]);
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const statusToSet = 'In Review';
            const PROJECT_TITLE = 'Combat Command';

            const { repository } = await github.graphql(`
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  projectsV2(first: 10) {
                    nodes {
                      id
                      title
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2Field { id, name }
                          ... on ProjectV2SingleSelectField { id, name, options { id, name } }
                        }
                      }
                    }
                  }
                }
              }
            `, { owner, repo });

            const project = repository.projectsV2.nodes.find(p => p.title === PROJECT_TITLE);
            if (!project) {
              console.log(`Project "${PROJECT_TITLE}" not found.`);
              return;
            }

            const statusField = project.fields.nodes.find(f => f.name === 'Status');
            const statusOption = statusField?.options?.find(o => o.name === statusToSet);
            if (!statusField || !statusOption) {
              console.log('Could not find status field or matching option.');
              return;
            }

            const { repository: issueRepo } = await github.graphql(`
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) {
                    id
                    projectItems(first: 10) {
                      nodes { id, project { id } }
                    }
                  }
                }
              }
            `, { owner, repo, number: issueNumber });

            const item = issueRepo.issue.projectItems.nodes.find(n => n.project.id === project.id);
            if (!item) {
              console.log(`Issue #${issueNumber} is not in the project.`);
              return;
            }

            await github.graphql(`
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }
                ) { projectV2Item { id } }
              }
            `, {
              projectId: project.id,
              itemId: item.id,
              fieldId: statusField.id,
              optionId: statusOption.id,
            });

            console.log(`Issue #${issueNumber} updated to "${statusToSet}"`);
