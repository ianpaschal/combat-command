name: PR Closed Automation

on:
  pull_request:
    types: [closed]
    branches:
      - develop
      - master

jobs:
  update-project-status:
    runs-on: ubuntu-latest

    steps:
      - name: Update project status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_AUTOMATION_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const body = context.payload.pull_request.body || '';
            const baseBranch = context.payload.pull_request.base.ref;

            const issueNumbers = [...body.matchAll(/#(\d+)/g)].map(m => parseInt(m[1]));
            if (issueNumbers.length === 0) {
              console.log('No issues referenced.');
              return;
            }

            const statusToSet = baseBranch === 'master' ? 'Done' : 'Ready to Deploy';
            const PROJECT_TITLE = 'Combat Command';

            console.log(`Setting status to: ${statusToSet} for issues: ${issueNumbers.join(', ')}`);

            const { repository } = await github.graphql(`
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  projectsV2(first: 10) {
                    nodes {
                      id
                      title
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2Field { id, name }
                          ... on ProjectV2SingleSelectField { id, name, options { id, name } }
                        }
                      }
                    }
                  }
                }
              }
            `, { owner, repo });

            const project = repository.projectsV2.nodes.find(p => p.title === PROJECT_TITLE);
            if (!project) {
              console.log(`Project "${PROJECT_TITLE}" not found.`);
              return;
            }

            const statusField = project.fields.nodes.find(f => f.name === 'Status');
            const statusOption = statusField?.options?.find(o => o.name === statusToSet);
            if (!statusField || !statusOption) {
              console.log('Could not find status field or matching option.');
              return;
            }

            for (const issueNumber of issueNumbers) {
              const { repository: issueRepo } = await github.graphql(`
                query($owner: String!, $repo: String!, $number: Int!) {
                  repository(owner: $owner, name: $repo) {
                    issue(number: $number) {
                      id
                      projectItems(first: 10) {
                        nodes { id, project { id } }
                      }
                    }
                  }
                }
              `, { owner, repo, number: issueNumber });

              const item = issueRepo.issue.projectItems.nodes.find(n => n.project.id === project.id);
              if (!item) {
                console.log(`Issue #${issueNumber} is not in the project.`);
                continue;
              }

              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $projectId,
                      itemId: $itemId,
                      fieldId: $fieldId,
                      value: { singleSelectOptionId: $optionId }
                    }
                  ) { projectV2Item { id } }
                }
              `, {
                projectId: project.id,
                itemId: item.id,
                fieldId: statusField.id,
                optionId: statusOption.id,
              });

              console.log(`Issue #${issueNumber} updated to "${statusToSet}"`);
            }
